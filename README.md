# IFLYTEK-AI-developer-competition-top-2

# 2020 科大讯飞 iFLYTEK A.I. 开发者大赛

## 多模态情感分析与识别挑战赛-心电图赛道

### 一. 参赛团队-心电图赛道第2名

* 团队名称：木木枭一家
* 团队成员：木木枭；annen（SpsdIzaJ）


### 二. 比赛环境

* 硬件：MacBook Pro 2020
* 软件：Python 3.7.6; Jupyter Notebook

### 三. 模型代码

* ```Data``` 目录：用于保存复赛数据集，其中训练数据集保存在 ```Train``` 目录，测试数据集保存在 ```Test``` 目录
* ```Model``` 目录：用于保存训练得到的模型文件
* ```Output``` 目录：用于保存模型在测试集上的预测结果
* ```trainPrep.py```：用于提取训练集时域特征与频域特征的 Python 文件
* ```testPrep.py```：用于提取测试集时域特征与频域特征的 Python 文件
* ```train_data.csv```：提取得到的训练集时域特征与频域特征数据
* ```test_data.csv```：提取得到的测试集时域特征与频域特征数据
* ```xgbModel.ipynb```：用于训练 XGBoost 模型的 Jupyter Notebook 文件
* ```xgbPrediction.ipynb```：用于预测测试集上最终结果的 Jupyter Notebook 文件

### 四. 运行流程

1. 运行 ```trainPrep.py``` 文件，该文件首先将较长的训练集心电信号切分为长度与测试集心电信号长度相近的小样本数据，然后使用小波阈值去噪法对训练集心电信号进行预处理，并基于 Pan-Tompkins 方法和最大值搜索方法定位检测P-QRS-T波，最终从中提取出174个特征用于训练，其中包括时域特153个，频域特征21个。这些特征保存在 ```train_data.csv``` 文件中；
2. 运行 ```testPrep.py``` 文件，该文件使用小波阈值去噪法对测试集心电信号进行预处理，并基于 Pan-Tompkins 方法和最大值搜索方法定位检测P-QRS-T波，最终从中提取出测试集的174个特征，其中包括时域特153个，频域特征21个。这些特征保存在 ```test_data.csv``` 文件中；
3. 运行 ```xgbModel.ipynb``` 文件，该文件对训练特征进行标准化处理，并训练 XGBoost 模型，得到的模型保存在 ```Model``` 目录下的 ```XGB.pickle.dat``` 文件中；
4. 运行 ```xgbPrediction.ipynb``` 文件，该文件使用上述得到的 XGBoost 模型对测试数据进行预测，最终得到的预测结果保存在 ```Output``` 目录下的 ```xgb_result.csv``` 文件中；
5. 最后提交 ```Output``` 目录下的 ```xgb_result.csv``` 文件即可。

### 五. 原理解释

#### 1. 特征提取

心电信号的特征提取是以P-QRS-T波的正确检测为基础的。由于心电信号是在强噪声下的低频微弱信号，一般典型的心电信号是mV级信号，其频带范围在0.05-100HZ，其中ECG频谱能量90%以上集中在0.25-35Hz。通常，QRS波群能量集中在3-40Hz，而P和T波能量主要处于0.5-10Hz。

在心电信号的采集中，有来自自身的干扰（如机电干扰），也有来自外界的干扰（如工频干扰）等，从而导致信号的信噪比下降。所以，心电信号的特征提取主要包括两个方面：对心电信号进行**去噪处理**，以及**P-QRS-T波的精确检测**。

##### 1.1. 去噪处理：小波阈值去噪法

心电信号在采集过程会受到各种各样的噪声干扰，最主要的是基线漂移和工频干扰。小波分析方法具有多分辨率的特点，能够很好的处理心电信号所面对的噪声。因此，我们选择采用**小波阈值去噪法**对心电信号进行预处理：我们选定适合的小波基和分解层数，将原始信号经过小波分解得到尺度系数，之后进行阈值处理和重构得到去噪后的心电波形。

##### 1.2. P-QRS-T波检测：Pan-Tompkins (P-T) 算法 & 最大值搜索方法

我们选择首先基于 Pan-Tompkins 的QRS波检测算法准确定位R波，然后再用最大值搜索方法相继检测出Q波、S波、P波和T波。

###### 1.2.1. R波检测：Pan-Tompkins (P-T) 算法

P-T 算法是一种双阈值检测QRS波群的实时算法。该算法首先采用带通滤波（通常为 5- 15 Hz）对心电信号进行滤波，微分（一阶差分）后再平方，平方过程可得出微分后的频响曲线斜率，并有助于区分由于一些高频分量引起的假阳性，再做滑动窗口平均积分，如果微分信号和积分信号分别同时达到阈值条件，就认为检测到一个QRS波，并且自动更新阈值。该算法的优势在于：采用数字带通滤波器来提高抗噪声性能，并能根据检测到的QRS波形变化进行自适应的调节阈值和参数，从而提高灵敏度。具体步骤如下：

1. **对心电信号时序数据进行处理**：对滤波后的信号进行五点差分处理，得到QRS复波的斜率信息，之后对差分后的信号做平方处理，突出信号的高频分量，由于这样的波峰仍然可能为双峰的，我们利用滑动窗口积分将双峰去除；
2. **R波检测**：对经过处理过的心电信号进行R波检测，如果被检查的波峰值高于所设定的阈值A1时，则认为此波为R波，否则认为该波峰为噪声；当被检测到的波峰被认定为R波时，便自动忽略掉该波峰前后200ms内所有其他的波峰；每检测到一个R波计算总的R-R间期均值，如果在上一个R波后1.5倍RR平均间期内没有检测到高于阈值A1的波峰，则将所检测到的大于阈值A2的且出现在上一个R波后360ms后的波峰作为R波。

###### 1.2.2. QSPT波检测：最大值搜索方法

定位R波之后，我们采用最大值搜索方法相继检测出Q波、S波、P波和T波。具体步骤如下：

1. **Q波检测**：我们以R波的峰值点为基准点，向前一段时刻范围内搜索的幅值极小值为Q波顶点；
2. **S波检测**：我们以R波的峰值点为基准点，向后一段时刻范围内搜索的幅值极小值为S波顶点；
3. **T波检测**：T波峰值位置为RR间隔17%-50%时间段内的最大值；
4. **P波检测**：P波峰值位置为RR间隔75%-83.33%时间段内的最大值。

##### 1.3. 心电信号情感特征提取

在准确定位P-QRS-T波后，我们根据定位结果提取出共174个特征：其中包括时域特153个，频域特征21个。

###### 1.3.1. 时域特征提取

时域特征由如下几个部分组成：

1. 以相邻P、Q、R、S、T波间隔，P、Q、R、S、T波峰值为基础，计算每个人每种情感状态下每一种关键点的平均值，中间值，标准差，最小值，最大值，以及振幅范围；
2. 以P-Q、Q-S、S-T间隔，S-T、P-T振幅，相邻RR波幅度差，相邻TT波幅度差，PTQ波能量特征值为基础，计算每个人每种情感状态下每一种关键点的平均值，中间值，标准差，最小值，最大值，以及振幅范围；
3. 以R-R间期为基础计算HRV（心率变异率）时域下的特征值：RR特征值、HR特征值、RMSSD特征值、pNN50；
4. 由于情感变化剧烈时，心率上升或者下降的幅度会增加，因此我们把上升幅度、上升时间、下降幅度和下降时间也作为心率特征计入时域特征。

###### 1.3.2. 频域特征提取

频域特征是从心电图的RR间隔信号中提取频域方面的参数。主要由以下几个部分组成：

1. 以 0-0.04 Hz频段（VLF）的功率为基础的统计特征值；
2. 以 0.04-0.15 Hz频段（LF）的功率为基础的统计特征值；
3. 以 0.15-0.4Hz 频段（HF）的功率为基础的统计特征值；
4. 针对 VLF、LF和HF频带的功率谱密度（PSD）估计的峰值频率。

#### 2. 模型训练：XGBoost 模型

基于我们提取的时域特征和频域特征的特点以及实践的一些经验，我们考虑使用 XGBoost 模型进行训练。XGBoost 是对 GBDT 模型的一种高效实现，相比 GBDT模型，XGBoost 在算法原理、运行效率和算法的鲁棒性等方面都有了一定的优化。鉴于本次提供的训练数据量并不巨大，深度学习相关算法不一定能取得很好的效果，因此我们选择了使用同样热门的 XGBoost 模型。

##### 2.1. 标准化：Z-Score

我们首先对数据进行了标准化。我们选择了最常见的标准分数（Standard Score/Z-Score） 来进行这一步骤：
$$
z = \frac{x-\mu}{\sigma}
$$
其中 $x$ 为某个特征的一个具体值，$\mu$ 为该特征的均值，$\sigma$ 为该特征的标准差，$z$ 就是这个具体值对应的 Z-Score，用它替换原来的 $x$ 即可完成标准化。

##### 2.2. 超参数调优：随机搜索 (Random Search)

在对 XGBoost 模型进行超参数调优时，我们采用了随机搜索 (Random Search) 的方法。我们设定了一个超参数的搜索范围，在这个给定的超参数空间中进行固定次数的随机搜索。虽然传统的网格搜索能够遍历空间内所有的超参数组合，但是这样会导致搜索的时间过长，计算的复杂度较高等问题，并且有可能导致不必要的计算。相比之下，随机搜索就不存在这些问题，而且一般也能得到不错的结果。我们具体使用的超参数组合在 ```xgbModel.ipynb``` 文件里可见。

##### 2.3. 模型训练与预测

使用随机搜索得到的超参数组合进行训练，并将训练得到的模型用于测试集的预测就能得到最终的结果。最终提交的结果在 ```Output``` 目录下的 ```xgb_result.csv``` 文件中可见。

